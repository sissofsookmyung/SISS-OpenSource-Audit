# Cosign(629f5f)

### 1. 개요

---

| 항목        | 내용                                              |
| ----------- | ------------------------------------------------- |
| 커밋 해시   | `629f5f8fa672973503edde75f84dcd984637629e`        |
| 관련 CVE    | CVE-2024-29902 (High Severity)                    |
| 패치 버전   | v2.2.4 (2024년 4월 릴리스 포함)                   |
| 취약점 유형 | CWE-400: Uncontrolled Resource Consumption (DoS)  |
| 분석 대상   | `pkg/oci/static/layer.go` (정적 레이어 생성 로직) |

### 2. 보안 문제

---

악의적으로 조작된 대용량 컨테이너 아티팩트 검증 시 발생하는 서비스 거부(DoS)

- 취약점 세부
  - 서명 검증 과정에서 레지스트리로부터 서명(Signature), 증명서(Attestation), SBOM 등의 첨부 파일을 다운로드하여 메모리에 로드
  - 공격 시나리오
    - 수십 GB 규모의 악성 파일을 레지스트리에 업로드하고, 이를 검증하도록 유도하거나 자동화된 파이프라인이 이를 처리하게 함
  - 영향
    - Cosign이 파일 크기를 사전에 확인하거나 제한하지 않고 메모리로 읽어 들이려 시도
    - 시스템 메모리의 급격한 고갈
    - CI/CD 파이프라인 셧다운 혹은 쿠버네티스 컨트롤러의 크래시 유발

### 3. 발생 원인

---

- 무제한 데이터 읽기
  - 기존 코드
    - 외부 입력 데이터 스트림을 처리 시 `io.ReadAll`을 사용하여 EOF까지 무조건 읽어들임
- 입력값 검증 부재
  - 최대 허용 크기(Max Size)에 대한 검증 로직 누락
    - 첨부 파일(Layer)이 시스템 메모리를 초과할 정도로 크지 않을 것이라는 가정

### 4. 해결

---

데이터를 메모리에 올리기 전이나 읽는 도중에 크기 제한을 강제함으로써, Cosign은 지정된 바이트(Byte)까지만 읽은 후 즉시 연결을 끊거나 에러를 발생시켜 메모리 고갈을 방지

1. Limited Reader
   - 데이터를 읽을 때 `io.ReadAll`을 직접 호출하지 않고 설정된 최대 크기까지만 읽도록 제한
2. 최대 크기 검증 로직 추가
   - 정적 레이어를 생성 시 입력 데이터의 크기가 허용된 한도를 초과하는지 검사

### 5. 시사점

---

- 리소스 고갈 공격 차단
  - 입력 처리 방식 제한을 통해 OOM 공격에 대한 대비
- 방어적 코딩
  - 원격 레지스트리의 데이터를 신뢰하지 않음
- 시스템 안정성 확보
  - 예외 상황(대용량 파일) 발생 시 프로세스가 비정상 종료되는 대신, 명시적인 오류를 반환하며 안전하게 실패하도록 개선

### 6. 결론

---

형식이나 내용 확인뿐만 아니라, 데이터의 양에 대한 검증이 필요

특히 Go 언어 환경에서 외부 소스로부터 데이터를 읽을 때는 `io.ReadAll` 대신 `io.LimitReader` 등을 사용하여 메모리 상한선을 두는 것이 중요

### 7. 참고 자료

---

- **CVE Record:** [NVD - CVE-2024-29902](https://nvd.nist.gov/vuln/detail/cve-2024-29902)
- **GitHub Advisory:** [GHSA-88jx-383q-w4qc](https://github.com/advisories/GHSA-88jx-383q-w4qc)
