# [Semgrep] 커밋 분석 - [6ba6f9008]

**주제:** `Log.debug` 뮤텍스 교착 상태(Deadlock) 해결을 통한 애플리케이션 가용성 패치

---

## 🧩 개요
- **커밋 해시:** `6ba6f9008`
- **작성자:** Iago Abal (`iago@semgrep.com`)
- **작성일:** 2025-11-18
- **파일 변경:**
  - `libs/commons/Logs_.ml` (구현부 수정)
  - `libs/commons/Logs_.mli` (인터페이스 수정)
  - `src/tainting/Shape_and_sig.ml` (호출부 수정)
- **관련 PR/릴리즈:** `semgrep/semgrep-proprietary#5028` (내부 이슈 트래커)

---

## 🔍 변경 요약
**1. `if_in_debug` 조건부 실행 함수 도입**
- 기존에는 로그 메시지 생성을 위한 연산이 즉시 수행되었으나, 변경 후에는 `if_in_debug` 함수가 현재 로그 레벨을 먼저 검사한다.
- `Logs.Debug` 레벨이 아닐 경우, 전달된 함수(콜백)를 실행하지 않고 즉시 리턴(`unit`)하여 불필요한 **Lock 획득 시도**를 원천 차단한다

**2. 호출 로직의 지연 평가(Lazy Evaluation) 적용**
- `Shape_and_sig.ml`에서 `show call_effects`를 `eval_and_show call_effects`로 변경했습니다.
- 이는 무거운 문자열 연산(`String.concat`)과 Lock이 필요한 작업이 디버깅 상황이 아닐 때 실행되는 것을 방지합니다.

---

## 🔐 보안 관점 분석 (CIA: Availability)

| 항목 | 이전 버전 (Before) | 변경 버전 (After) | 보안적 의미 |
|:---:|---|---|---|
| **로깅 메커니즘** | 로그 레벨과 무관하게 연산 수행 중 뮤텍스(Lock) 경합 발생 가능 | `if_in_debug`를 통해 로그 레벨 선검증 후 실행 (`Check-then-Act`) | **가용성(Availability) 확보.** 교착 상태(Deadlock)로 인한 프로세스 멈춤(Hang) 방지. |
| **리소스 사용** | 불필요한 문자열 연산으로 인한 CPU/메모리 자원 점유 | 디버그 모드가 아닐 경우 연산 스킵 | **DoS(서비스 거부) 방지.** 대량의 트래픽/스캔 요청 시 리소스 고갈 예방. |

---

## 🧾 검증 및 확인
- [x] **관련 PR/릴리즈 로그 확인:** 커밋 메시지 내 `#5028` 이슈 번호 및 "mutex deadlock" 키워드 확인.
- [ ] **보안 패치(CVE) 여부 확인:** 확인 결과, 정식 **CVE ID는 부여되지 않음** (보안 취약점보다는 치명적 버그 수정으로 분류됨).
- [x] **코드 로직 확인:** OCaml의 패턴 매칭(`match Logs.Src.level src with`)을 사용하여 `Debug` 레벨일 때만 로직이 수행됨을 코드 레벨에서 검증함.

---

## 💬 결론
- [x] **업데이트 성격:** 기능 개선 및 버그 수정 (안정성 패치)
- [x] **CI/CD 신뢰성 영향:** 있음
    - *설명:* CI 파이프라인이나 대규모 스캔 작업 시 Semgrep이 멈추지 않고 끝까지 실행됨을 보장하여 보안 스캔의 신뢰도를 높임.
- [ ] **추가 확인 필요사항:**
    - `Log.debug`를 사용하는 다른 모듈에도 동일한 래퍼 함수(`if_in_debug`) 적용이 필요한지 코드 전수 조사 권장.

---

## 📚 참고
- **GitHub 저장소:** [https://github.com/semgrep/semgrep](https://github.com/semgrep/semgrep)
- **관련 개념:** Mutex Deadlock, Lazy Evaluation, Race Condition